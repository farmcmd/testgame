<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã€Œè‡ºå¤§ã€‚æ£®æ—ã€‚å­¸é™¢2.0ã€é‡Œå±±ç”Ÿæ…‹å»Šé“ è¾²ç”°å¾®æ£²åœ°-ç”Ÿæ…‹å°è¦½æ´»å‹•å°æ¸¬é©—</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap');
        
        /* --- CARD GAME STYLES --- */
        .perspective {
            perspective: 1000px;
        }
        .card {
            width: 100%;
            aspect-ratio: 1 / 1;
            background-color: transparent;
            cursor: pointer;
        }
        .card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.6s;
            transform-style: preserve-3d;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            border-radius: 0.5rem;
        }
        .card.is-flipped .card-inner {
            transform: rotateY(180deg);
        }
        .card-front, .card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden; /* Safari */
            backface-visibility: hidden;
            border-radius: 0.5rem;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2.5rem;
        }
        .card-front {
            background-color: #4ade80; /* green-400 */
            color: white;
            border: 4px solid #166534; /* green-800 */
            font-size: 3rem;
        }
        .card-back {
            background-color: #f0fdf4; /* green-50 */
            color: #1a202c;
            transform: rotateY(180deg);
            border: 4px solid #4ade80; /* green-400 */
        }
        /* --- END CARD GAME STYLES --- */

        /* --- PARTNER REGISTRATION STYLES --- */
        .partner-slot {
            background-color: #f0fdf4; /* green-50 */
            border: 2px solid #4ade80; /* green-400 */
            border-radius: 0.5rem;
            padding: 0.75rem;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .partner-avatar {
            font-size: 3rem;
            margin-bottom: 0.5rem;
        }
        .partner-name-input, .discussion-textarea { /* Added discussion-textarea */
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #9ca3af; /* gray-400 */
            border-radius: 0.25rem;
            text-align: center;
            font-family: 'Noto Sans TC', sans-serif;
        }
        .partner-name-input::placeholder, .discussion-textarea::placeholder { /* Added discussion-textarea */
            color: #9ca3af; /* gray-400 */
        }
         /* Specific style for textarea alignment */
        .discussion-textarea {
            text-align: left; /* Align text left for better readability */
            min-height: 80px; /* Give some initial height */
            border-color: #cbd5e1; /* gray-300 for discussion text area border */
        }
         /* Style for Export Button */
        .export-button {
            display: inline-block;
            background-color: #22c55e; /* green-500 */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: bold;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.2s;
            border: none;
            font-size: 1.1rem;
        }
        .export-button:hover {
            background-color: #16a34a; /* green-600 */
        }
        /* --- END PARTNER REGISTRATION STYLES --- */

        /* --- FIELD TYPE STYLES --- */
        .field-type-option {
            display: flex;
            flex-wrap: wrap; 
            align-items: center;
            background-color: #f0fdf4; 
            border: 2px solid #a7f3d0; 
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .field-type-option:hover {
            border-color: #4ade80; 
        }
        .field-type-option input[type="radio"] {
            margin-right: 0.75rem;
            accent-color: #166534; 
            width: 1.25rem;
            height: 1.25rem;
        }
        .field-type-option.selected {
            background-color: #d1fae5; 
            border-color: #166534; 
        }
        .field-type-option.selected span {
            font-weight: bold;
        }
        #other-field-type-details {
             border-color: #9ca3af; 
        }
        /* --- END FIELD TYPE STYLES --- */

        /* --- DANGER STYLES --- */
        .danger-option {
            display: flex;
            align-items: center;
            background-color: #fef2f2; 
            border: 2px solid #fecaca; 
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .danger-option:hover {
            border-color: #f87171; 
        }
        .danger-option input[type="checkbox"] {
            margin-right: 0.75rem;
            accent-color: #b91c1c; 
            width: 1.25rem;
            height: 1.25rem;
            flex-shrink: 0;
        }
        .danger-option.selected {
            background-color: #fee2e2; 
            border-color: #b91c1c; 
        }
        .danger-option.selected span {
            font-weight: bold;
            color: #b91c1c; 
        }
        #other-dangers-details input {
             border-color: #fecaca; 
        }
        /* --- END DANGER STYLES --- */

         /* --- BENEFIT STYLES --- */
        .benefit-option {
            display: flex;
            align-items: center;
            background-color: #eff6ff; 
            border: 2px solid #bfdbfe; 
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .benefit-option:hover {
            border-color: #60a5fa; 
        }
        .benefit-option input[type="checkbox"] {
            margin-right: 0.75rem;
            accent-color: #1e40af; 
            width: 1.25rem;
            height: 1.25rem;
            flex-shrink: 0;
        }
        .benefit-option.selected {
            background-color: #dbeafe; 
            border-color: #1e40af; 
        }
        .benefit-option.selected span {
            font-weight: bold;
            color: #1e40af; 
        }
        #other-benefits-details input {
             border-color: #bfdbfe; 
        }
        /* --- END BENEFIT STYLES --- */


        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f0fdf4;
        }
        .game-scene {
            position: relative;
            width: 100%;
            aspect-ratio: 4 / 3;
            max-width: 1200px;
            margin: auto;
            background: linear-gradient(to bottom, #87ceeb 30%, #a1d9a3 30%);
            overflow: hidden;
            border-radius: 1rem;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            border: 8px solid #654321;
        }
        #connection-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 15;
        }
        .forest { position: absolute; top: 0; left: 0; width: 35%; height: 50%; background: #228b22; clip-path: polygon(0 0, 100% 0, 100% 60%, 80% 100%, 0 100%); z-index: 1; }
        .low-mountain { position: absolute; top: 5%; left: 20%; width: 40%; height: 40%; background: #556b2f; border-radius: 50% 50% 0 0; z-index: 0; }
        .farm-plot { position: absolute; background-color: #f5deb3; border: 2px solid #cd853f; }
        .farm-1 { top: 45%; left: 5%; width: 30%; height: 25%; transform: skew(-15deg); z-index: 2;}
        .farm-2 { top: 50%; left: 40%; width: 35%; height: 30%; background-color: #d2b48c; z-index: 2;}
        .farm-3 { top: 75%; left: 10%; width: 35%; height: 20%; transform: skew(10deg); z-index: 2;}
        .stream { position: absolute; top: 30%; left: 70%; width: 25%; height: 70%; background: #add8e6; clip-path: polygon(20% 0, 40% 0, 75% 100%, 55% 100%); z-index: 5; }
        .pond { position: absolute; bottom: 5%; right: 5%; width: 25%; height: 20%; background: #4682b4; border-radius: 50%; z-index: 6; }
        .agricultural-facility { position: absolute; top: 38%; left: 58%; width: 50px; height: 40px; background: #9ca3af; z-index: 4;}
        .farmhouse { position: absolute; top: 60%; left: 70%; width: 80px; height: 60px; background: #d2691e; z-index: 10;}
        .farmhouse::after { content: ''; position: absolute; top: -30px; left: 0; width: 0; height: 0; border-left: 40px solid transparent; border-right: 40px solid transparent; border-bottom: 30px solid #a0522d; }
        .road { position: absolute; top: 30%; left: 0; width: 100%; height: 8%; background: #696969; z-index: 3; }
        .landscape-label { position: absolute; color: white; background-color: rgba(0, 0, 0, 0.6); padding: 2px 8px; border-radius: 6px; font-size: 1rem; font-weight: bold; z-index: 20; pointer-events: none; }
        .game-icon { position: absolute; font-size: 1rem; text-align: center; transition: all 1s ease-in-out; z-index: 25; }
        .game-icon span { display: block; font-size: 0.6rem; font-weight: bold; color: #000; background-color: rgba(255,255,255,0.5); border-radius: 4px; padding: 0 2px;}
        .disturbance-icon { transition: transform 0.5s ease-out; background: none !important; }
        .disturbance-icon .icon-symbol { font-size: 2.5rem; color: red; animation: pulse 1.5s infinite; text-shadow: 0 0 5px white; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }
        @keyframes move-randomly { 0% { transform: translate(0, 0); } 25% { transform: translate(var(--x1), var(--y1)); } 50% { transform: translate(var(--x2), var(--y2)); } 75% { transform: translate(var(--x3), var(--y3)); } 100% { transform: translate(0, 0); } }
        .animal.active { animation: move-randomly 10s infinite; }
        
        .drop-zone { position: absolute; border: 3px dashed rgba(255, 0, 0, 0.7); background: rgba(255, 100, 100, 0.2); border-radius: 10px; z-index: 35; transition: background-color 0.3s; cursor: pointer; }
        
        .drop-zone.hovered { background: rgba(255, 100, 100, 0.5); }
        .drop-zone.occupied { border-style: solid; border-color: #228b22; background-color: transparent; }
        .facility { cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; padding: 0.25rem 0.5rem; }
        .facility.selected { box-shadow: 0 0 15px yellow; transform: scale(1.05); }
        .facility.placed { opacity: 0.4; cursor: not-allowed; background-color: #d1d5db; }
        .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100; display: flex; justify-content: center; align-items: center; }
        
        #animal-pen {
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(4px);
            padding: 8px;
            border-radius: 8px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 1rem;
        }
        .pen-animal {
            transition: opacity 0.5s;
            font-size: 1.8rem;
            background-color: rgba(255,255,255,0.8);
            border-radius: 5px;
            padding: 2px;
            line-height: 1;
        }
        #magic-wand-cursor {
            position: fixed;
            font-size: 2.5rem;
            pointer-events: none;
            z-index: 9999;
            transform: translate(-10px, -40px);
            transition: opacity 0.2s;
            opacity: 0;
            display: none;
        }
        #score-display {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: rgba(255, 255, 255, 0.8);
            padding: 5px 15px;
            border-radius: 10px;
            font-size: 1.5rem;
            font-weight: bold;
            color: #1a202c;
            z-index: 40;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
         /* Utility class to hide elements */
        .hidden {
            display: none;
        }
    </style>
</head>
<body class="bg-green-50 text-gray-800 p-4 lg:p-8">
    <div id="magic-wand-cursor">ğŸª„</div>
    <div id="game-container" class="max-w-7xl mx-auto">
        
        <!-- --- CARD GAME HTML --- -->
        <div id="card-game-container" class="mb-8 p-4 bg-white rounded-lg shadow-inner">
            <h2 id="card-game-title" class="text-2xl font-bold text-center text-green-800 mb-2">ç”Ÿæ…‹åˆ†çµ„éŠæˆ²</h2>
            <p id="card-game-prompt" class="text-center text-gray-600 mb-4 h-12">(é»æ“Šå¡ç‰ŒæŸ¥çœ‹ä½ çš„åˆ†çµ„)</p>
            <div id="card-grid" class="grid grid-cols-6 gap-2 md:gap-4 max-w-2xl mx-auto perspective">
                <!-- Cards will be injected here by JS -->
            </div>
             <p class="text-center text-gray-700 mt-4 text-sm md:text-base px-2">
                æŠ½åˆ°åˆ†çµ„çš„ç”Ÿç‰©å¾Œï¼Œç«‹å³é–‹å§‹æ‚¨çš„è§’è‰²æ‰®æ¼”éŠæˆ²ï¼Œæ‚¨éœ€è¦ä»¥æŠ½åˆ°çš„ç”Ÿç‰©çœ¼å…‰å»çœ‹å¾…ç›®å‰å‘¨é­çš„ç’°å¢ƒï¼Œä¸¦æ‰¾åˆ°æ‚¨çš„å¤¥ä¼´ä¸€èµ·æ¢éšªï¼Œç™¼ç¾ç”Ÿæ…‹ç’°å¢ƒçš„å•é¡ŒåŠè§£æ±ºçš„è¾¦æ³•ã€‚
            </p>
        </div>
        <!-- --- END CARD GAME HTML --- -->

        <!-- --- PARTNER REGISTRATION SECTION --- -->
        <div id="partner-registration" class="my-8 p-4 bg-white rounded-lg shadow-inner">
            <h2 class="text-2xl font-bold text-center text-green-800 mb-4">ç¬¬äºŒéšæ®µï¼šå¤¥ä¼´å ±åˆ°</h2>
            <p class="text-center text-gray-600 mb-6">è«‹åœ¨ä¸‹æ–¹è¼¸å…¥7ä½å¤¥ä¼´çš„åå­—ï¼š</p>
            <div id="partner-grid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-4 max-w-6xl mx-auto">
                <!-- 7 partner slots will be generated by JS -->
            </div>
        </div>
        <!-- --- END PARTNER REGISTRATION SECTION --- -->

         <!-- --- FIELD TYPE SELECTION SECTION --- -->
        <div id="field-type-selection" class="my-8 p-4 bg-white rounded-lg shadow-inner">
            <h2 class="text-2xl font-bold text-center text-green-800 mb-4">ç¬¬ä¸‰éšæ®µï¼šå ´åŸŸå‹æ…‹</h2>
            <p class="text-center text-gray-600 mb-6">è«‹é¸æ“‡æ‚¨æ‰€åœ¨çš„å ´åŸŸå‹æ…‹ï¼š</p>
            <div id="field-type-grid" class="grid grid-cols-2 md:grid-cols-3 gap-4 max-w-4xl mx-auto">
                <!-- Options will be generated by JS -->
            </div>
        </div>
        <!-- --- END FIELD TYPE SELECTION SECTION --- -->

        <!-- --- DANGER SELECTION SECTION --- -->
        <div id="danger-selection" class="my-8 p-4 bg-white rounded-lg shadow-inner">
            <h2 class="text-2xl font-bold text-center text-green-800 mb-4">ç¬¬å››éšæ®µï¼šæ¢éšªå±å®³</h2>
            <p class="text-center text-gray-600 mb-6">è«‹é¸æ“‡æ‚¨åœ¨æ¢éšªä¸­é­é‡äº†å“ªäº›å°æˆ‘å€‘éšŠä¼(æ—ç¾¤)æœ‰åš´é‡å±å®³çš„å±éšªï¼š</p>
            <div id="danger-grid" class="grid grid-cols-2 md:grid-cols-3 gap-4 max-w-4xl mx-auto">
                <!-- Dangers will be generated by JS -->
            </div>
            <!-- Container for 'Other' details -->
            <div id="other-dangers-details" class="hidden mt-4 max-w-4xl mx-auto space-y-2">
                <!-- 5 text inputs will be generated by JS -->
            </div>
        </div>
        <!-- --- END DANGER SELECTION SECTION --- -->

         <!-- --- ECOSYSTEM BENEFITS SECTION --- -->
        <div id="ecosystem-benefits-selection" class="my-8 p-4 bg-white rounded-lg shadow-inner">
            <h2 class="text-2xl font-bold text-center text-green-800 mb-4">ç¬¬äº”éšæ®µï¼šç”Ÿæ…‹å¥½è™•</h2>
            <p class="text-center text-gray-600 mb-6">å‘Šè¨´å¤§å®¶æˆ‘çš„æ—ç¾¤å­˜åœ¨èƒ½å¤ å¸¶ä¾†ç”šéº¼ç”Ÿæ…‹å¥½è™•(ç”Ÿæ…‹æœå‹™)ï¼š</p>
            <div id="benefits-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4 max-w-4xl mx-auto">
                <!-- Benefits will be generated by JS -->
            </div>
            <!-- Container for 'Other' details -->
            <div id="other-benefits-details" class="hidden mt-4 max-w-4xl mx-auto space-y-2">
                <!-- 5 text inputs will be generated by JS -->
            </div>
        </div>
        <!-- --- END ECOSYSTEM BENEFITS SECTION --- -->

         <!-- --- DISCUSSION SECTION --- -->
        <div id="discussion-section" class="my-8 p-4 bg-white rounded-lg shadow-inner">
            <h2 class="text-2xl font-bold text-center text-green-800 mb-4">ç¬¬å…­éšæ®µï¼šè¨è«–äº¤æµ</h2>
            <div class="max-w-4xl mx-auto space-y-4">
                <div>
                    <label for="habitat-needed" class="block text-gray-700 font-semibold mb-2">æˆ‘å€‘éœ€è¦ä»€éº¼æ¨£çš„æ£²åœ°ï¼Ÿ</label>
                    <textarea id="habitat-needed" name="habitat-needed" rows="4" class="discussion-textarea" placeholder="è«‹æè¿°æ‚¨çš„æ—ç¾¤ç†æƒ³çš„æ£²åœ°æ¨£è²Œ..."></textarea>
                </div>
                 <div>
                    <label for="habitat-improvement" class="block text-gray-700 font-semibold mb-2">æˆ‘å€‘å¯ä»¥å¦‚ä½•æ”¹å–„ï¼Ÿ</label>
                    <textarea id="habitat-improvement" name="habitat-improvement" rows="4" class="discussion-textarea" placeholder="è«‹æå‡ºæ”¹å–„æ£²åœ°çš„å…·é«”å»ºè­°..."></textarea>
                </div>
            </div>
        </div>
        <!-- --- END DISCUSSION SECTION --- -->

        <!-- --- QUIZ COMPLETION SECTION --- -->
        <div id="quiz-completion-section" class="my-8 p-4 bg-white rounded-lg shadow-inner">
            <h2 class="text-2xl font-bold text-center text-green-800 mb-4">ç¬¬ä¸ƒéšæ®µï¼šå®Œæˆå°æ¸¬é©—</h2>
            <p class="text-center text-gray-600 mb-6 max-w-3xl mx-auto">
                ç¶œåˆå‰é¢éšæ®µçš„æ¢éšªç™¼ç¾èˆ‡è¨è«–çµæœï¼Œç¾åœ¨è«‹æ ¹æ“šæ‚¨å°ç†æƒ³æ£²åœ°çš„ç†è§£ï¼Œå®Œæˆä¸‹æ–¹çš„ã€Œè¾²ç”°å¾®æ£²åœ°-ç”Ÿæ…‹å°è¦½æ´»å‹•å°æ¸¬é©—ã€ã€‚é¸æ“‡åˆé©çš„ç”Ÿæ…‹è¨­æ–½ï¼Œä¸¦å°‡å®ƒå€‘æ”¾ç½®åˆ°æœ€èƒ½ç™¼æ®ä½œç”¨çš„ä½ç½®å§ï¼
            </p>
        </div>
        <!-- --- END QUIZ COMPLETION SECTION --- -->


        <!-- --- ECOLOGY GAME SECTIONS --- -->
        <header class="text-center mb-4">
            <h1 class="text-2xl md:text-3xl font-bold text-green-800">ã€Œè‡ºå¤§ã€‚æ£®æ—ã€‚å­¸é™¢2.0ã€é‡Œå±±ç”Ÿæ…‹å»Šé“</h1>
            <h2 class="text-xl md:text-2xl font-semibold text-green-700">è¾²ç”°å¾®æ£²åœ°-ç”Ÿæ…‹å°è¦½æ´»å‹•å°æ¸¬é©—</h2>
        </header>

        <div id="animal-pen-container" class="mb-4">
            <h3 class="text-md font-bold text-center mb-2">å¾…é€²é§ç”Ÿç‰©</h3>
            <div id="animal-pen"></div>
        </div>

        <div class="flex flex-col">
            <main class="w-full">
                <div id="scene" class="game-scene">
                    <canvas id="connection-canvas"></canvas>
                    <div id="score-display">åˆ†æ•¸: 0</div>
                    <div class="forest"></div>
                    <div class="low-mountain"></div>
                    <div class="road"></div>
                    <div class="farm-plot farm-1"></div>
                    <div class="farm-plot farm-2"></div>
                    <div class="farm-plot farm-3"></div>
                    <div class="stream"></div>
                    <div class="pond"></div>
                    <div class="agricultural-facility"></div>
                    <div class="farmhouse"></div>
                    <div class="landscape-label" style="top: 5%; left: 5%;">æ£®æ—</div>
                    <div class="landscape-label" style="top: 10%; left: 30%;">æ·ºå±±</div>
                    <div class="landscape-label" style="top: 55%; left: 15%;">è¾²ç”°</div>
                    <div class="landscape-label" style="top: 60%; left: 48%;">è¾²ç”°</div>
                    <div class="landscape-label" style="top: 80%; left: 20%;">è¾²ç”°</div>
                    <div class="landscape-label" style="top: 40%; left: 78%;">æºªæµ</div>
                    <div class="landscape-label" style="bottom: 12%; right: 15%;">æ°´å¡˜</div>
                    <div class="landscape-label" style="top: 48%; left: 57%;">è¾²æ¥­è¨­æ–½</div>
                    <div class="landscape-label" style="top: 72%; left: 72%;">è¾²èˆ</div>
                    <div class="landscape-label" style="top: 31%; left: 2%;">å±±é‚Šé“è·¯</div>
                </div>
                <div id="connection-counter" class="mt-2 text-center text-lg font-bold text-green-700 bg-green-100 p-2 rounded-lg">
                    å·²é€£æ¥ 0 å€‹ç”Ÿæ…‹æ£²åœ°
                </div>
            </main>

            <aside class="w-full bg-white p-4 rounded-lg shadow-lg mt-8">
                <h3 class="text-lg font-bold border-b-2 border-green-600 pb-2 mb-2">ç”Ÿæ…‹è¨­æ–½ <span class="text-sm font-normal text-gray-600">(é»æ“Šè¨­æ–½ï¼Œç”¨é­”æ³•æ£’ç§»å‹•åˆ°æ­£ç¢ºä½ç½®å†é»æ“Š)</span></h3>
                <div id="facilities-list" class="flex flex-wrap gap-2"></div>
            </aside>
        </div>
        <!-- --- END ECOLOGY GAME SECTIONS --- -->

        <!-- --- MOVED EXPORT SECTION --- -->
        <div id="export-section" class="my-8 p-4 bg-white rounded-lg shadow-inner text-center">
            <h2 class="text-2xl font-bold text-center text-green-800 mb-4">ç¬¬å…«éšæ®µï¼šåŒ¯å‡ºçµæœ</h2>
            <p class="text-center text-gray-600 mb-6">é»æ“Šä¸‹æ–¹æŒ‰éˆ•ï¼Œå°‡æ‚¨åœ¨å„éšæ®µå¡«å¯«çš„å…§å®¹èˆ‡æ¸¬é©—åˆ†æ•¸åŒ¯å‡ºæˆHTMLæª”æ¡ˆã€‚</p>
            <button id="export-button" class="export-button">åŒ¯å‡ºçµæœ</button>
        </div>
        <!-- --- END EXPORT SECTION --- -->


        <footer class="text-center mt-6 text-xs text-gray-500">
            <p>å…±åŒé–‹ç™¼å–®ä½ï¼šç¤¾åœ˜æ³•äººå—æŠ•ç¸£æ°´é‡Œé„‰å•†åœˆå‰µç”Ÿå…±å¥½å”æœƒ | ç¤¾åœ˜æ³•äººå—æŠ•ç¸£é’å¹´è¾²æ°‘æ°¸çºŒç™¼å±•å”æœƒ | æ°´é‡Œé‡Œå±±åŸºåœ°#é‡Œå±±é¤æ¡Œåœ˜éšŠ #æ°´é‡Œé’è¾² | æ°´é‡Œç‡Ÿæ—å€</p>
            <p>Â© 2025 æ°´é‡Œæ°¸çºŒå…±å¥½è¯ç›Ÿ | V1.0ï¼Œã€Œé‡Œå±±é¤æ¡Œã€åœ˜éšŠè¨­è¨ˆ</p>
        </footer>
    </div>

    <div id="feedback-modal" class="modal-backdrop hidden"><div class="bg-white rounded-lg shadow-2xl p-6 w-11/12 md:max-w-lg mx-auto transform transition-all duration-300 scale-95 opacity-0 max-h-[90vh] overflow-y-auto"><h3 id="modal-title" class="text-2xl font-bold text-green-700 mb-4">å¤ªæ£’äº†ï¼</h3><div id="modal-content" class="text-base text-left"></div><button id="modal-close-btn" class="mt-6 w-full bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition-colors">ç¹¼çºŒæ¢ç´¢</button></div></div>
    <div id="sroi-modal" class="modal-backdrop hidden"><div class="bg-white rounded-lg shadow-2xl p-6 w-11/12 md:max-w-2xl mx-auto transform transition-all duration-300 scale-95 opacity-0 max-h-[90vh] overflow-y-auto"><h3 class="text-3xl font-bold text-center text-yellow-500 mb-4">æ­å–œï¼æ‚¨å·²æˆåŠŸä¸²é€£æ‰€æœ‰é—œéµæ£²åœ°ï¼</h3><div class="text-base text-left space-y-6"><div><h4 class="text-xl font-bold text-green-800 border-b-2 border-green-200 pb-2 mb-3">ğŸ‘¨â€ğŸŒ¾ çµ¦è¾²å‹çš„æ°¸çºŒç´…åˆ©ï¼šç”Ÿç”¢èˆ‡ç”Ÿæ…‹çš„é›™è´</h4><ul class="list-disc list-inside space-y-2 text-gray-700"><li><b>ç”Ÿæ…‹æœå‹™å¢å¼·ï¼š</b>é€éè‰å¸¶ã€æ¿•åœ°å¸å¼•ä¾†çš„èœœèœ‚ã€ç“¢èŸ²ã€é’è›™ï¼Œèƒ½å¹«åŠ©ä½œç‰©æˆç²‰ã€åƒæ‰å®³èŸ²ï¼Œæœ‰æ•ˆæ¸›å°‘è¾²è—¥èˆ‡è‚¥æ–™æˆæœ¬ï¼Œè®“åœŸåœ°æ›´å¥åº·ã€‚</li><li><b>å“ç‰Œåƒ¹å€¼æå‡ï¼š</b>ã€Œç‚ºç”Ÿæ…‹è€•ä½œã€æœ¬èº«å°±æ˜¯æœ€æ£’çš„æ•…äº‹ï¼ç”Ÿæ…‹å‹å–„çš„ç”¢å“ï¼ˆå¦‚çŸ³è™ç±³ã€ç©¿å±±ç”²èŒ¶ï¼‰èƒ½ç²å¾—æ¶ˆè²»è€…èªåŒï¼Œå‰µé€ æ›´é«˜çš„å“ç‰Œåƒ¹å€¼èˆ‡å¸‚å ´å€éš”ã€‚</li><li><b>ç¤¾æœƒè³‡æœ¬ç´¯ç©ï¼š</b>å±•ç¾è¾²å ´çš„ç¤¾æœƒæŠ•è³‡å ±é…¬ç‡(SROI)ï¼Œæ›´å®¹æ˜“çˆ­å–æ”¿åºœè£œåŠ©æˆ–ä¼æ¥­çš„ESGåˆä½œï¼Œä¸¦æˆç‚ºç¤¾å€å¼•ä»¥ç‚ºå‚²çš„ç’°å¢ƒæ•™è‚²å ´åŸŸã€‚</li></ul></div><div><h4 class="text-xl font-bold text-blue-800 border-b-2 border-blue-200 pb-2 mb-3">ğŸ¤ æˆ‘å€‘å¦‚ä½•æ”¯æŒç”Ÿæ…‹è¾²å‹</h4><div class="grid md:grid-cols-2 gap-6"><div><h5 class="font-bold text-lg mb-2">ğŸ™‹â€â™€ï¸ èº«ç‚ºæ¶ˆè²»è€…</h5><ul class="list-disc list-inside space-y-2 text-gray-700"><li><b>ç”¨æ–°å°å¹£ä¸‹æ¶ï¼š</b>å„ªå…ˆè³¼è²·æœ‰ç”¢éŠ·å±¥æ­·ã€ç¶ è‰²ä¿è‚²æ¨™ç« çš„ç”¢å“ã€‚</li><li><b>è¦ªèº«é«”é©—èˆ‡åˆ†äº«ï¼š</b>åƒåŠ é£Ÿè¾²æ•™è‚²ã€ç”Ÿæ…‹å°è¦½ï¼Œä¸¦åœ¨ç¤¾ç¾¤åˆ†äº«æ‚¨çš„æ„Ÿå‹•ã€‚</li><li><b>ç†è§£åƒ¹å€¼å·®ç•°ï¼š</b>äº†è§£å‹å–„ç”¢å“çš„åƒ¹æ ¼ï¼ŒåŒ…å«äº†å°ç’°å¢ƒçš„æ„›è­·æˆæœ¬ã€‚</li></ul></div><div><h5 class="font-bold text-lg mb-2">ğŸ¢ èº«ç‚ºä¼æ¥­</h5><ul class="list-disc list-inside space-y-2 text-gray-700"><li><b>å¯¦è¸ ESG/CSRï¼š</b>å°‡æ”¯æŒç”Ÿæ…‹è¾²æ¥­ç´å…¥ä¼æ¥­çš„æ°¸çºŒç™¼å±•ç­–ç•¥ä¸­ã€‚</li><li><b>ä¼æ¥­æ¡è³¼èˆ‡åˆä½œï¼š</b>æ¡è³¼å‹å–„è¾²ç”¢å“ä½œç‚ºå“¡å·¥ç¦åˆ©æˆ–ä¼æ¥­è´ˆç¦®ã€‚</li><li><b>æŠ•è³‡ç”Ÿæ…‹å¾©è‚²ï¼š</b>è´ŠåŠ©è¾²å ´çš„ç”Ÿæ…‹è¨­æ–½ï¼ˆå¦‚èªé¤Šä¸€ç‰‡æ¿•åœ°ï¼‰ï¼Œä½œç‚ºä¼æ¥­çš„æ°¸çºŒç¸¾æ•ˆã€‚</li></ul></div></div></div></div><button id="sroi-modal-close-btn" class="mt-8 w-full bg-yellow-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-yellow-600 transition-colors text-lg">æˆ‘æ˜ç™½äº†ï¼ä¸€èµ·ç‚ºæ°¸çºŒåŠªåŠ›ï¼</button></div></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        
        // --- CARD GAME LOGIC ---
        const cardGrid = document.getElementById('card-grid');
        const cardGameTitle = document.getElementById('card-game-title');
        const cardGamePrompt = document.getElementById('card-game-prompt');
        const creatures = ['ğŸ', 'ğŸ¢', 'ğŸ¸', 'ğŸ†', 'ğŸ”', 'ğŸ']; 
        let gameCards = [];
        let lockBoard = false; 
        let selectedCreature = null; // Variable to store selected creature

        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function createCardElement(creature) {
            const card = document.createElement('div');
            card.classList.add('card');
            card.dataset.creature = creature;
            
            card.innerHTML = `
                <div class="card-inner">
                    <div class="card-front">
                        <span>ğŸƒ</span>
                    </div>
                    <div class="card-back">
                        <span>${creature}</span>
                    </div>
                </div>
            `;
            card.addEventListener('click', flipCard);
            return card;
        }

        function flipCard() {
            if (lockBoard) return; 
            if (this.classList.contains('is-flipped')) return; 

            lockBoard = true; 
            this.classList.add('is-flipped');
            
            selectedCreature = this.dataset.creature; // Store the selected creature
            
            if (cardGamePrompt) {
                cardGamePrompt.innerHTML = `ä½ æŠ½åˆ°çš„æ˜¯ <strong class="text-xl">${selectedCreature}</strong>ï¼<br>è«‹å»æ‰¾åˆ°å¦ä¸€ä½æŠ½åˆ° <strong class="text-xl">${selectedCreature}</strong> çš„å¤¥ä¼´ï¼`;
            }
        }

        function initCardGame() {
            if (!cardGrid) return; 
            lockBoard = false; 
            selectedCreature = null; // Reset selected creature
            cardGrid.innerHTML = ''; 
            gameCards = shuffle([...creatures]); 
            gameCards.forEach(creature => {
                const cardElement = createCardElement(creature);
                cardGrid.appendChild(cardElement);
            });
            if (cardGameTitle) {
                cardGameTitle.textContent = 'ç”Ÿæ…‹åˆ†çµ„éŠæˆ²';
            }
            if (cardGamePrompt) {
                cardGamePrompt.innerHTML = '(é»æ“Šå¡ç‰ŒæŸ¥çœ‹ä½ çš„åˆ†çµ„)';
            }
        }
        
        initCardGame();
        // --- END CARD GAME LOGIC ---


        // --- PARTNER REGISTRATION LOGIC ---
        function initPartnerRegistration() {
            const partnerGrid = document.getElementById('partner-grid');
            if (!partnerGrid) return;

            partnerGrid.innerHTML = ''; 
            const partnerAvatars = ['ğŸ§‘â€ğŸŒ¾', 'ğŸ‘©â€ğŸ”¬', 'ğŸ‘¨â€ğŸ«', 'ğŸ‘©â€ğŸ¨', 'ğŸ‘¨â€ğŸ’»', 'ğŸ‘©â€ğŸ³', 'ğŸ§‘â€ğŸš€']; 

            for (let i = 0; i < 7; i++) {
                const slot = document.createElement('div');
                slot.className = 'partner-slot';
                
                slot.innerHTML = `
                    <div class="partner-avatar">${partnerAvatars[i]}</div>
                    <input type="text" class="partner-name-input" placeholder="å¤¥ä¼´ ${i + 1} åå­—">
                `;
                partnerGrid.appendChild(slot);
            }
        }
        initPartnerRegistration();
        // --- END PARTNER REGISTRATION LOGIC ---

        // --- FIELD TYPE SELECTION LOGIC ---
        function initFieldTypeSelection() {
            const fieldTypeGrid = document.getElementById('field-type-grid');
            if (!fieldTypeGrid) return;

            fieldTypeGrid.innerHTML = ''; 
            const fieldTypes = [
                'éƒŠå¤–', 'è¾²ç”°', 'å…¬åœ’', 'ç¤¾å€', 'æ·ºå±±æ­¥é“', 'å…¶ä»–'
            ];

            fieldTypes.forEach(type => {
                const optionLabel = document.createElement('label');
                optionLabel.className = 'field-type-option';
                optionLabel.setAttribute('for', `field-type-${type}`);

                let content = `
                    <input type="radio" name="field-type" id="field-type-${type}" value="${type}">
                    <span>${type}</span>
                `;
                
                if (type === 'å…¶ä»–') {
                    content += `<input type="text" id="other-field-type-details" class="partner-name-input hidden w-full mt-2" placeholder="è«‹èªªæ˜...">`;
                }

                optionLabel.innerHTML = content;
                fieldTypeGrid.appendChild(optionLabel);
            });

            const radioButtons = document.querySelectorAll('input[name="field-type"]');
            const otherDetailsInput = document.getElementById('other-field-type-details');

            radioButtons.forEach(radio => {
                radio.addEventListener('change', (e) => {
                    document.querySelectorAll('.field-type-option').forEach(label => label.classList.remove('selected'));
                    const selectedLabel = e.target.closest('.field-type-option');
                    if (selectedLabel) selectedLabel.classList.add('selected');
                    if (otherDetailsInput) {
                        if (e.target.value === 'å…¶ä»–') {
                            otherDetailsInput.classList.remove('hidden');
                            otherDetailsInput.focus();
                        } else {
                            otherDetailsInput.classList.add('hidden');
                        }
                    }
                });
            });

            if (otherDetailsInput) {
                otherDetailsInput.addEventListener('click', (e) => e.stopPropagation()); 
                otherDetailsInput.parentElement.addEventListener('click', (e) => {
                    if (e.target.tagName !== 'INPUT') {
                        const otherRadio = document.getElementById('field-type-å…¶ä»–');
                        if (otherRadio && !otherRadio.checked) { // Check if otherRadio exists
                            otherRadio.checked = true;
                            otherRadio.dispatchEvent(new Event('change'));
                        }
                    }
                });
            }
        }
        initFieldTypeSelection();
        // --- END FIELD TYPE SELECTION LOGIC ---

        // --- DANGER SELECTION LOGIC ---
        function initDangerSelection() {
            const dangerGrid = document.getElementById('danger-grid');
            const otherDangersContainer = document.getElementById('other-dangers-details');
            if (!dangerGrid || !otherDangersContainer) return;

            dangerGrid.innerHTML = ''; 
            const dangers = [
                'éåº¦ç…§æ˜', 'é“è·¯è·¯æ®º', 'åŒ–è‚¥ä½¿ç”¨', 
                'æµæµªç‹—å±å®³', 'è¾²è—¥æ¼‚ç§»', 'åƒåœ¾å †ç©', 
                'è¾²æ©Ÿå¹²æ“¾', 'æ’æ°´æºçµ„éš”', 'å¯†é›†å»ºç¯‰',
                'æ›´å¤š' 
            ];

            dangers.forEach(danger => {
                const optionLabel = document.createElement('label');
                optionLabel.className = 'danger-option';
                optionLabel.setAttribute('for', `danger-${danger}`);
                
                optionLabel.innerHTML = `
                    <input type="checkbox" name="danger" id="danger-${danger}" value="${danger}">
                    <span>${danger}</span>
                `;
                dangerGrid.appendChild(optionLabel);
            });

            otherDangersContainer.innerHTML = ''; 
            for (let i = 1; i <= 5; i++) {
                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'partner-name-input w-full'; 
                input.placeholder = `å…¶ä»–å±å®³èªªæ˜ ${i}...`;
                input.addEventListener('click', (e) => e.stopPropagation()); 
                otherDangersContainer.appendChild(input);
            }

            const checkBoxes = document.querySelectorAll('input[name="danger"]');
            const otherCheckbox = document.getElementById('danger-æ›´å¤š');

            checkBoxes.forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    const selectedLabel = e.target.closest('.danger-option');
                    if (!selectedLabel) return;
                    if (e.target.checked) selectedLabel.classList.add('selected');
                    else selectedLabel.classList.remove('selected');

                    if (e.target.id === 'danger-æ›´å¤š') {
                        if (e.target.checked) otherDangersContainer.classList.remove('hidden');
                        else otherDangersContainer.classList.add('hidden');
                    }
                });
            });
             // Ensure clicking label checks the box for "Other" danger
             if (otherCheckbox) {
                 const otherLabel = otherCheckbox.closest('.danger-option');
                 if(otherLabel){
                     otherLabel.addEventListener('click', (e)=>{
                          // Only check the box if the click wasn't on the input itself
                          // and the checkbox isn't already checked
                          if(e.target.tagName !== 'INPUT' && !otherCheckbox.checked){
                              otherCheckbox.checked = true;
                              // Manually trigger the change event to update styles and show/hide fields
                              otherCheckbox.dispatchEvent(new Event('change'));
                         }
                     });
                 }
             }
        }
        initDangerSelection();
        // --- END DANGER SELECTION LOGIC ---

         // --- ECOSYSTEM BENEFITS LOGIC ---
        function initEcosystemBenefitsSelection() {
            const benefitsGrid = document.getElementById('benefits-grid');
            const otherBenefitsContainer = document.getElementById('other-benefits-details');
            if (!benefitsGrid || !otherBenefitsContainer) return;

            benefitsGrid.innerHTML = ''; // Clear existing
            const benefits = [
                'è‡ªç„¶çš„å®³èŸ²æ§åˆ¶ é™ä½å°åŒ–å­¸è¾²è—¥çš„ä¾è³´', 
                'æ¿•åœ°å’Œæ°´æºçš„é‡è¦æŒ‡æ¨™', 
                'é£Ÿç‰©éˆå‹•ç‰©çš„é£Ÿç‰©ä¾†æº', 
                'æ¼”ç”Ÿæ…‹ç³»ã€Œæ¸…é“å¤«ã€çš„è§’è‰²', 
                'å‚³æ’­ç¨®å­', 
                'æ§åˆ¶å›“é½’å‹•ç‰©ï¼ˆè€é¼ ï¼‰çš„æ•¸é‡', 
                'å®Œæˆæˆç²‰ä¿è­·æ¤ç‰©å¤šæ¨£æ€§',
                'å…¶ä»–' // Special case
            ];

            benefits.forEach(benefit => {
                 // Use a simpler, more reliable ID generation
                const benefitId = `benefit-${benefit.replace(/[\s\W]+/g, '-')}`; 
                const optionLabel = document.createElement('label');
                optionLabel.className = 'benefit-option';
                optionLabel.setAttribute('for', benefitId); 
                
                optionLabel.innerHTML = `
                    <input type="checkbox" name="benefit" id="${benefitId}" value="${benefit}">
                    <span>${benefit}</span>
                `;
                benefitsGrid.appendChild(optionLabel);
            });

            otherBenefitsContainer.innerHTML = ''; // Clear
            for (let i = 1; i <= 5; i++) {
                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'partner-name-input w-full'; // Reuse style
                input.placeholder = `å…¶ä»–ç”Ÿæ…‹å¥½è™•èªªæ˜ ${i}...`;
                input.addEventListener('click', (e) => e.stopPropagation()); 
                otherBenefitsContainer.appendChild(input);
            }

            const checkBoxes = document.querySelectorAll('input[name="benefit"]');
             // Use the generated ID to find the 'Other' checkbox
            const otherCheckbox = document.getElementById('benefit-å…¶ä»–'); 

            checkBoxes.forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    const selectedLabel = e.target.closest('.benefit-option');
                    if (!selectedLabel) return;
                    
                    if (e.target.checked) {
                        selectedLabel.classList.add('selected');
                    } else {
                        selectedLabel.classList.remove('selected');
                    }

                    // Special check for 'More' checkbox using its generated ID
                    if (e.target.id === 'benefit-å…¶ä»–') { 
                        if (e.target.checked) {
                            otherBenefitsContainer.classList.remove('hidden');
                        } else {
                            otherBenefitsContainer.classList.add('hidden');
                        }
                    }
                });
            });
             if (otherCheckbox) {
                 const otherLabel = otherCheckbox.closest('.benefit-option');
                 if(otherLabel){
                     otherLabel.addEventListener('click', (e)=>{
                          if(e.target.tagName !== 'INPUT' && !otherCheckbox.checked){
                              otherCheckbox.checked = true;
                              otherCheckbox.dispatchEvent(new Event('change'));
                         }
                     });
                 }
             }
        }
        initEcosystemBenefitsSelection();
        // --- END ECOSYSTEM BENEFITS LOGIC ---

         // --- DISCUSSION SECTION LOGIC ---
        function initDiscussionSection() {
            const habitatNeeded = document.getElementById('habitat-needed');
            const habitatImprovement = document.getElementById('habitat-improvement');
            // Logic for this section can be added here
        }
        initDiscussionSection();
        // --- END DISCUSSION SECTION LOGIC ---

        // --- NEW EXPORT LOGIC ---
        function exportResults() {
            let htmlContent = `<!DOCTYPE html><html lang="zh-Hant"><head><meta charset="UTF-8"><title>ç”Ÿæ…‹æ´»å‹•çµæœ</title>`;
            htmlContent += `<style> body { font-family: 'Noto Sans TC', sans-serif; line-height: 1.6; padding: 20px; max-width: 800px; margin: auto; } h1, h2 { color: #166534; border-bottom: 2px solid #a7f3d0; padding-bottom: 5px;} h2 { margin-top: 30px; } ul { list-style: disc; margin-left: 20px;} li { margin-bottom: 5px; } .label { font-weight: bold; color: #1e3a8a; } </style>`;
            htmlContent += `</head><body>`;
            htmlContent += `<h1>ç”Ÿæ…‹å°è¦½æ´»å‹•çµæœ</h1>`;

            // Stage 1: Creature
            htmlContent += `<h2>ç¬¬ä¸€éšæ®µï¼šç”Ÿæ…‹åˆ†çµ„éŠæˆ²</h2>`;
            htmlContent += `<p><span class="label">æŠ½åˆ°çš„ç”Ÿç‰©ï¼š</span> ${selectedCreature || 'å°šæœªé¸æ“‡'}</p>`;

            // Stage 2: Partners
            htmlContent += `<h2>ç¬¬äºŒéšæ®µï¼šå¤¥ä¼´å ±åˆ°</h2><ul>`;
            const partnerInputs = document.querySelectorAll('#partner-grid .partner-name-input');
            partnerInputs.forEach((input, index) => {
                htmlContent += `<li><span class="label">å¤¥ä¼´ ${index + 1}ï¼š</span> ${input.value || 'æœªå¡«å¯«'}</li>`;
            });
            htmlContent += `</ul>`;

            // Stage 3: Field Type
            htmlContent += `<h2>ç¬¬ä¸‰éšæ®µï¼šå ´åŸŸå‹æ…‹</h2>`;
            const selectedFieldType = document.querySelector('input[name="field-type"]:checked');
            if (selectedFieldType) {
                htmlContent += `<p><span class="label">é¸æ“‡çš„å ´åŸŸï¼š</span> ${selectedFieldType.value}</p>`;
                if (selectedFieldType.value === 'å…¶ä»–') {
                    const otherDetails = document.getElementById('other-field-type-details')?.value;
                    htmlContent += `<p><span class="label">å…¶ä»–èªªæ˜ï¼š</span> ${otherDetails || 'æœªå¡«å¯«'}</p>`;
                }
            } else {
                htmlContent += `<p>å°šæœªé¸æ“‡å ´åŸŸå‹æ…‹</p>`;
            }

            // Stage 4: Dangers
            htmlContent += `<h2>ç¬¬å››éšæ®µï¼šæ¢éšªå±å®³</h2>`;
            const selectedDangers = document.querySelectorAll('input[name="danger"]:checked');
            if (selectedDangers.length > 0) {
                htmlContent += `<ul>`;
                let otherDangerDetailsAdded = false;
                selectedDangers.forEach(dangerCheckbox => {
                     htmlContent += `<li>${dangerCheckbox.value}</li>`;
                     if (dangerCheckbox.value === 'æ›´å¤š') {
                        const otherDangerInputs = document.querySelectorAll('#other-dangers-details input');
                        otherDangerInputs.forEach((input, index) => {
                             if(input.value.trim() !== ''){
                                 htmlContent += `<li style="margin-left: 20px;">å…¶ä»– ${index + 1}ï¼š${input.value}</li>`;
                                 otherDangerDetailsAdded = true;
                             }
                        });
                     }
                });
                htmlContent += `</ul>`;
                 const otherDangerCheckbox = document.getElementById('danger-æ›´å¤š'); // Check the element exists
                 if (otherDangerCheckbox && otherDangerCheckbox.checked && !otherDangerDetailsAdded) {
                     htmlContent += `<p>å·²å‹¾é¸ã€Œæ›´å¤šã€ï¼Œä½†æœªå¡«å¯«èªªæ˜ã€‚</p>`;
                 }
            } else {
                htmlContent += `<p>æœªé¸æ“‡ä»»ä½•å±å®³</p>`;
            }

            // Stage 5: Benefits
            htmlContent += `<h2>ç¬¬äº”éšæ®µï¼šç”Ÿæ…‹å¥½è™•</h2>`;
            const selectedBenefits = document.querySelectorAll('input[name="benefit"]:checked');
             if (selectedBenefits.length > 0) {
                htmlContent += `<ul>`;
                let otherBenefitDetailsAdded = false;
                selectedBenefits.forEach(benefitCheckbox => {
                     htmlContent += `<li>${benefitCheckbox.value}</li>`;
                     if (benefitCheckbox.value === 'å…¶ä»–') { // Check against the value 'å…¶ä»–'
                        const otherBenefitInputs = document.querySelectorAll('#other-benefits-details input');
                        otherBenefitInputs.forEach((input, index) => {
                             if(input.value.trim() !== ''){
                                 htmlContent += `<li style="margin-left: 20px;">å…¶ä»– ${index + 1}ï¼š${input.value}</li>`;
                                 otherBenefitDetailsAdded = true;
                             }
                        });
                     }
                });
                htmlContent += `</ul>`;
                 // Check the actual checkbox element's checked state
                 const otherBenefitCheckbox = document.getElementById('benefit-å…¶ä»–'); // Check element exists
                 if (otherBenefitCheckbox && otherBenefitCheckbox.checked && !otherBenefitDetailsAdded) {
                     htmlContent += `<p>å·²å‹¾é¸ã€Œå…¶ä»–ã€ï¼Œä½†æœªå¡«å¯«èªªæ˜ã€‚</p>`;
                 }
            } else {
                htmlContent += `<p>æœªé¸æ“‡ä»»ä½•ç”Ÿæ…‹å¥½è™•</p>`;
            }


            // Stage 6: Discussion
            htmlContent += `<h2>ç¬¬å…­éšæ®µï¼šè¨è«–äº¤æµ</h2>`;
            const habitatNeeded = document.getElementById('habitat-needed')?.value || 'æœªå¡«å¯«';
            const habitatImprovement = document.getElementById('habitat-improvement')?.value || 'æœªå¡«å¯«';
            htmlContent += `<p><span class="label">æˆ‘å€‘éœ€è¦ä»€éº¼æ¨£çš„æ£²åœ°ï¼Ÿ</span><br>${habitatNeeded.replace(/\n/g, '<br>')}</p>`;
            htmlContent += `<p><span class="label">æˆ‘å€‘å¯ä»¥å¦‚ä½•æ”¹å–„ï¼Ÿ</span><br>${habitatImprovement.replace(/\n/g, '<br>')}</p>`;

            // Stage 7: Quiz Score
            htmlContent += `<h2>ç¬¬ä¸ƒéšæ®µï¼šå°æ¸¬é©—åˆ†æ•¸</h2>`;
            // Ensure score is treated as a number, provide fallback
             const finalScore = typeof score === 'number' ? Math.round(score) : 'å°šæœªè¨ˆç®—';
            htmlContent += `<p><span class="label">æœ€çµ‚åˆ†æ•¸ï¼š</span> ${finalScore}</p>`;


            htmlContent += `</body></html>`;

            // Create blob and download link
            const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "ç”Ÿæ…‹æ´»å‹•çµæœ.html";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
             // Clean up the object URL
             URL.revokeObjectURL(link.href);
        }

        const exportButton = document.getElementById('export-button');
        if (exportButton) {
            exportButton.addEventListener('click', exportResults);
        }
        // --- END EXPORT LOGIC ---


        // --- MAIN ECOLOGY GAME LOGIC ---
        const gameData={
            animals:[{id:"leopard-cat-1",name:"çŸ³è™",icon:"ğŸ†",position:{top:"35%",left:"15%"},habitat:"forest",released:!1},{id:"ferret-badger-1",name:"é¼¬ç¾",icon:"ğŸ¦¡",position:{top:"42%",left:"22%"},habitat:"forest",released:!1},{id:"snake-1",name:"è›‡é¡",icon:"ğŸ",position:{top:"40%",left:"5%"},habitat:"forest",released:!1},{id:"tortoise-1",name:"é™¸é¾œ",icon:"ğŸ¢",position:{top:"50%",left:"12%"},habitat:"forest",released:!1},{id:"frog-1",name:"è«¸ç¾…æ¨¹è›™",icon:"ğŸ¸",position:{top:"56%",left:"8%"},habitat:"forest",released:!1},{id:"bird-1",name:"ç«¹é›",icon:"ğŸ”",position:{top:"20%",left:"10%"},habitat:"forest",released:!1},{id:"butterfly-3",name:"è´è¶",icon:"ğŸ¦‹",position:{top:"25%",left:"20%"},habitat:"forest",released:!1},{id:"frog-2",name:"æ¾¤è›™",icon:"ğŸ¸",position:{top:"85%",left:"65%"},habitat:"water_edge",released:!1},{id:"bird-2",name:"ç™½é·º",icon:"ğŸ¦¢",position:{top:"78%",left:"90%"},habitat:"water_edge",released:!1},{id:"fish-1",name:"é­šé¡",icon:"ğŸŸ",position:{top:"65%",left:"82%"},habitat:"water_edge",released:!1},{id:"dragonfly-1",name:"èœ»èœ“",icon:"ğŸ¦—",position:{top:"70%",left:"78%"},habitat:"water_edge",released:!1},{id:"aquatic-insect-1",name:"æ°´ç”Ÿæ˜†èŸ²",icon:"ğŸ¦Ÿ",position:{top:"80%",left:"75%"},habitat:"water_edge",released:!1},{id:"firefly-2",name:"è¢ç«èŸ²",icon:"ğŸ’¡",position:{top:"78%",left:"8%"},habitat:"water_edge",released:!1},{id:"frog-3",name:"æ¾¤è›™",icon:"ğŸ¸",position:{top:"95%",left:"35%"},habitat:"wetland",released:!1},{id:"tortoise-2",name:"çƒé¾œ",icon:"ğŸ¢",position:{top:"95%",left:"50%"},habitat:"wetland",released:!1},{id:"firefly-1",name:"è¢ç«èŸ²",icon:"ğŸ’¡",position:{top:"82%",left:"42%"},habitat:"wetland",released:!1},{id:"dragonfly-2",name:"èœ»èœ“",icon:"ğŸ¦—",position:{top:"83%",left:"48%"},habitat:"wetland",released:!1},{id:"aquatic-insect-2",name:"æ°´é»½",icon:"ğŸ¦Ÿ",position:{top:"93%",left:"52%"},habitat:"wetland",released:!1},{id:"butterfly-2",name:"è´è¶",icon:"ğŸ¦‹",position:{top:"82%",left:"33%"},habitat:"wetland",released:!1},{id:"frog-4",name:"é’è›™",icon:"ğŸ¸",position:{top:"68%",left:"30%"},habitat:"farm_corridor",released:!1},{id:"bee-2",name:"èœœèœ‚",icon:"ğŸ",position:{top:"65%",left:"55%"},habitat:"farm_corridor",released:!1},{id:"butterfly-1",name:"è´è¶",icon:"ğŸ¦‹",position:{top:"62%",left:"30%"},habitat:"farm_corridor",released:!1},{id:"bird-4",name:"ç«¹é›",icon:"ğŸ”",position:{top:"78%",left:"30%"},habitat:"farm_corridor",released:!1},{id:"ferret-badger-2",name:"é¼¬ç¾",icon:"ğŸ¦¡",position:{top:"62%",left:"25%"},habitat:"farm_corridor",released:!1},{id:"snake-3",name:"è›‡é¡",icon:"ğŸ",position:{top:"56%",left:"56%"},habitat:"farm_corridor",released:!1},{id:"bee-1",name:"èœœèœ‚",icon:"ğŸ",position:{top:"48%",left:"53%"},habitat:"farm_building",released:!1},{id:"bird-5",name:"éº»é›€",icon:"ğŸ¦œ",position:{top:"40%",left:"54%"},habitat:"farm_building",released:!1},{id:"ferret-badger-3",name:"é¼¬ç¾",icon:"ğŸ¦¡",position:{top:"48%",left:"62%"},habitat:"farm_building",released:!1}],
            disturbances:[{id:"disturbance-dog",name:"æµæµªç‹—",icon:"ğŸ•",position:{top:"31%",left:"92%"}},{id:"disturbance-pesticide",name:"è¾²è—¥æ¼‚ç§»",icon:"â˜ ï¸",position:{top:"60%",left:"60%"}},{id:"disturbance-machine",name:"è¾²æ©Ÿ",icon:"ğŸšœ",position:{top:"78%",left:"55%"}},{id:"disturbance-trash",name:"åƒåœ¾å †ç©",icon:"ğŸ—‘ï¸",position:{top:"40%",left:"85%"}},{id:"disturbance-ditch",name:"æ°´æ³¥æ’æ°´æº",icon:"ğŸ§±",position:{top:"75%",left:"2%"}},{id:"disturbance-light",name:"éåº¦ç…§æ˜",icon:"ğŸ’¡",position:{top:"25%",left:"45%"}},{id:"disturbance-roadkill",name:"é“è·¯è·¯æ®º",icon:"ğŸš—",position:{top:"32%",left:"45%"}},{id:"disturbance-fertilizer",name:"åŒ–è‚¥ä½¿ç”¨",icon:"ğŸ§ª",position:{top:"50%",left:"15%"}}],
            facilities:[{id:"f11",name:"æ£®æ—ç·©è¡å¸¶",icon:"ğŸŒ³",zone:"dz11",placed:!1,benefits:["forest"],reason:"ä½œç‚ºæ£®æ—èˆ‡è¾²ç”°ä¹‹é–“çš„éæ¸¡å€ï¼Œèƒ½æ¸›ç·©è¾²è€•æ´»å‹•å°æ£®æ—çš„å¹²æ“¾ï¼Œä¸¦æä¾›çŸ³è™ã€é¼¬ç¾ç­‰è¼ƒæ•æ„Ÿçš„å“ºä¹³å‹•ç‰©ä¸€å€‹å®‰å…¨çš„è¦“é£Ÿèˆ‡ç§»å‹•å‰ç·£ã€‚",howto:"<strong>ã€å¯¬åº¦ã€‘</strong>åœ¨æ£®æ—é‚Šç·£ä¿ç•™è‡³å°‘ 5â€“10 å…¬å°ºå¯¬çš„å€åŸŸã€‚<br><strong>ã€æ¤è¢«ã€‘</strong>ç‡Ÿé€ è‰æœ¬ã€çŒæœ¨ã€å°å–¬æœ¨ç­‰å¤šå±¤æ¬¡çš„æ¤è¢«çµæ§‹ï¼Œæ¨¡ä»¿è‡ªç„¶æ£®æ—æ¨£è²Œã€‚"},
            {id:"f1",name:"ç”°åŸ‚è‰å¸¶/å»Šé“",icon:"ğŸŒ¿",zone:"dz1",placed:!1,benefits:["farm_corridor"],reason:"æä¾›æˆç²‰æ˜†èŸ²(è´è¶ã€èœœèœ‚)ã€å¤©æ•µ(èœ˜è››ã€ç“¢èŸ²)åŠå°å‹å‹•ç‰©(é’è›™ã€è›‡)ä¸€å€‹é‡è¦çš„åº‡è­·ã€è¦“é£Ÿèˆ‡ç§»å‹•çš„é€šé“ï¼Œä¸²è¯ç ´ç¢çš„æ£²åœ°ã€‚",howto:"<strong>ã€å¯¬åº¦ã€‘</strong>åœ¨ç”°åŸ‚æˆ–ç”°é‚Šä¿ç•™ 1â€“3 å…¬å°ºå¯¬çš„æœªè€•ä½œå€ã€‚<br><strong>ã€æ¤è¢«ã€‘</strong>è®“åŸç”Ÿè‰é¡è‡ªç„¶ç”Ÿé•·ï¼Œæˆ–ç¨®æ¤é¦¬åˆ©ç­‹ã€è¬å£½èŠç­‰èœœæºæ¤ç‰©ã€‚<br><strong>ã€ç®¡ç†ã€‘</strong>ç¦æ­¢ä½¿ç”¨é™¤è‰åŠ‘ï¼Œå¯å®šæœŸäººå·¥ä¿®å‰ªä»¥é˜²éåº¦è”“å»¶ã€‚",sroiFarms:"æ¹§å¥é…ªæ¢¨è¾²å ´ã€é›¨ç¤¾å±±ä¸‹è¾²å ´ã€æŒ‡ä»¤æ•™è‚²è¾²å ´ã€é˜¿çˆ¾å–œæª¸æª¬"},
            {id:"f3",name:"ç”Ÿç‰©å‹å–„æ¶µæ´",icon:"ğŸ¾",zone:"dz3",placed:!1,benefits:["forest"],reason:"è®“ç¿’æ…£åœ¨åœ°é¢æ´»å‹•çš„å‹•ç‰©ï¼ˆå¦‚é¼¬ç¾ã€é£Ÿè›‡é¾œã€é’è›™ï¼‰å¯ä»¥å®‰å…¨ç©¿è¶Šç”°é–“é“è·¯ï¼Œé¿å…è¢«è¾²æ©Ÿæˆ–è»Šè¼›è¼¾æ–ƒ(è·¯æ®º)ã€‚",howto:"<strong>ã€åœ°é»ã€‘</strong>è¨­ç½®åœ¨ç”°é–“é“è·¯ã€ç”°åŸ‚ä¸‹æ–¹ã€‚<br><strong>ã€è¨­è¨ˆã€‘</strong>å…§å¾‘ç´„ 30-50 å…¬åˆ†ï¼Œå…§éƒ¨éœ€ä¿æŒæ˜æš—ã€æ¿•æ½¤ï¼Œæ´å£å…©å´æ‡‰æœ‰æ¤è¢«å¼•å°ã€‚",sroiFarms:"æ¹§å¥é…ªæ¢¨è¾²å ´ã€é›¨ç¤¾å±±ä¸‹è¾²å ´"},
            {id:"f5",name:"ç¶ åŒ–çŒæº‰æ°´é“",icon:"ğŸ’§",zone:"dz5",placed:!1,benefits:["water_edge"],reason:"æ°´æ³¥çŒæº‰æ°´é“ä¸€èˆ¬ç”±ä¸‰é¢å…‰æ»‘çš„æ°´æ³¥å»ºé€ ï¼Œç”Ÿç‰©ä¸æ˜“èº²è—ï¼›å‰µé€ ä¸€å€‹çŸ³ç Œä¸”ç¶ åŒ–çš„ç·©è¡å¸¶å¯ä¿æ°´ã€ä¿æ¿•ã€é™æº«çš„å¾®æ£²åœ°ï¼Œæˆç‚ºèŒèšªã€è›‡é¡ã€æ°´ç”Ÿæ˜†èŸ²çš„é¿é›£æ‰€èˆ‡ç§»å‹•é€šé“ã€‚",howto:"<strong>ã€çµæ§‹ã€‘</strong>å°‡æºæ¸ æ”¹ç‚ºè‡ªç„¶åœŸå¡æˆ–é‹ªè¨­åµçŸ³åº•ï¼Œæ¸›å°‘æ°´æ³¥åŒ–ã€‚<br><strong>ã€è¨­è¨ˆã€‘</strong>å…©å´ç¨®æ¤é‡è–‘èŠ±ã€é¦™è’²ç­‰æŒºæ°´æ¤ç‰©ï¼Œä¸¦åœ¨å‘¨é‚Šæ”¾ç½®ä¸å½±éŸ¿æ°´é«”æµå‹•çš„çŸ³å¡Šæˆ–æ¯æœ¨ä¾›å‹•ç‰©èº²è—ã€‚"},{id:"f6",name:"å°æ¿•åœ°",icon:"ğŸ¸",zone:"dz6",placed:!1,benefits:["wetland"],reason:"åœ¨è¾²ç”°ä¸­å‰µé€ ä¸€å€‹ç”Ÿç‰©å¤šæ¨£æ€§ç†±é»ï¼Œæ˜¯è›™é¡ã€èœ»èœ“ã€æ°´é³¥ç­‰å‹•ç‰©ç¹æ®–ã€è¦“é£Ÿã€æ£²æ¯çš„æ ¸å¿ƒå ´æ‰€ï¼Œä¹Ÿæ˜¯çµ•ä½³çš„ç”Ÿæ…‹æ•™è‚²é»ã€‚",howto:"<strong>ã€åœ°é»ã€‘</strong>åˆ©ç”¨ç”°å€è§’è½çš„ä½çªªè™•æˆ–ä¼‘è€•ç”°ã€‚<br><strong>ã€è¨­è¨ˆã€‘</strong>é¢ç©ç´„ 1.5â€“4 å…¬å°ºï¼Œæ°´æ·± 0.5-1 å…¬å°ºï¼Œé‚Šå¡ç·©é™ï¼Œåº•éƒ¨å¯ç”¨é»åœŸé˜²æ¼ã€‚ç¨®æ¤æ°´ç‡­ã€é‡æ…ˆå§‘ç­‰æ°´ç”Ÿæ¤ç‰©ã€‚"},{id:"f8",name:"æ°´å²¸ç·©è¡å¸¶",icon:"ğŸŒŠ",zone:"dz8",placed:!1,benefits:["water_edge"],reason:"ä¿è­·æºªæµã€æ°´å¡˜çš„æ°´è³ªï¼Œèƒ½æœ‰æ•ˆæ””æˆªã€éæ¿¾å¾è¾²ç”°æµå‡ºçš„è¾²è—¥èˆ‡è‚¥æ–™ï¼ŒåŒæ™‚æä¾›è±å¯Œçš„æ¿•åœ°ç”Ÿæ…‹ç³»è®“å¤šæ¨£ç”Ÿç‰©æ£²æ¯ã€‚",howto:"<strong>ã€å¯¬åº¦ã€‘</strong>åœ¨æ°´å²¸èˆ‡è¾²ç”°é–“ä¿ç•™ 5â€“15 å…¬å°ºå¯¬ã€‚<br><strong>ã€æ¤è¢«ã€‘</strong>ç”±æ°´é‚Šè‡³é™¸åœ°ï¼Œä¾åºç¨®æ¤æ°´ç”Ÿæ¤ç‰©ã€è‰æœ¬å±¤ã€çŒæœ¨å±¤ï¼Œå½¢æˆå¤šå±¤æ¬¡ä¿è­·ã€‚"},{id:"f9",name:"è‡ªç„¶åŒ–è­·å²¸",icon:"â›°ï¸",zone:"dz9",placed:!1,benefits:["water_edge"],reason:"å°‡å‚ç›´é™¡å³­çš„æ°´æ³¥å ¤å²¸ï¼Œæ”¹é€ ç‚ºå‹•ç‰©å¯è‡ªç”±é€²å‡ºçš„ç·©å¡ã€‚å¢åŠ æ°´é™¸äº¤ç•Œçš„æ£²åœ°å¤šæ¨£æ€§ï¼Œè®“é¾œã€è›™èƒ½è¼•æ˜“ä¸Šä¸‹å²¸ã€‚",howto:"<strong>ã€æ–¹å¼ã€‘</strong>ç§»é™¤éƒ¨åˆ†æ°´æ³¥å¡Šï¼Œå›å¡«åœŸå£¤ï¼Œæˆ–ä½¿ç”¨æŸ³æ¢ç·¨ç¹”çš„çŸ³ç± ã€æ¤ç”Ÿè¢‹ç­‰æŸ”æ€§ææ–™æ‰“é€ ç·©å¡ã€‚<br><strong>ã€è¨­è¨ˆã€‘</strong>å¡ä¸Šå¯ç¨®æ¤åŸç”Ÿè‰æœ¬æˆ–çŒæœ¨ï¼Œç©©å®šå¡é¢ã€‚"},{id:"f10",name:"æ¼‚æµ®æ£²åœ°",icon:"ğŸï¸",zone:"dz10",placed:!1,benefits:["wetland"],reason:"åœ¨æ°´åŸŸä¸­æä¾›ä¸€å€‹ç©©å®šçš„å¹³å°ï¼Œè®“èœ»èœ“ã€è±†å¨˜ç­‰æ˜†èŸ²å¯ä»¥åœæ£²ã€ç”¢åµï¼Œä¹Ÿè®“å°é’è›™æœ‰èº²é¿æ°´ä¸­å¤©æ•µçš„ä¼‘æ¯ç«™ã€‚",howto:"<strong>ã€ææ–™ã€‘</strong>ä½¿ç”¨ç«¹å­ã€ç„¡æ¯’å¡‘è† ç®¡ç­‰è£½æˆæ¡†æ¶ï¼Œä¸­é–“é‹ªè¨­ç¶²æˆ–ç¨®æ¤å¸ƒã€‚<br><strong>ã€æ¤è¢«ã€‘</strong>ç¨®æ¤ç©ºå¿ƒèœã€æ°´èŠ™è“‰ç­‰æ°´ç”Ÿæ¤ç‰©ï¼Œæ ¹ç³»å¯æä¾›æ°´ä¸­ç”Ÿç‰©åº‡è­·ã€‚"},{id:"f12",name:"æ¯æœ¨å †ã€è‰å †",icon:"ğŸªµ",zone:"dz12",placed:!1,benefits:["forest","wetland"],reason:"æä¾›ä¸€å€‹ç©©å®šã€æº«æ¿•åº¦è®ŠåŒ–å°çš„å¾®ç’°å¢ƒï¼Œæ˜¯è›‡ã€èœ¥èœ´ã€é¾œã€è›™ç­‰è®Šæº«å‹•ç‰©çµ•ä½³çš„èº²è—ã€è¦“é£Ÿæˆ–åº¦å†¬çš„å ´æ‰€ã€‚",howto:"<strong>ã€åœ°é»ã€‘</strong>åœ¨æ£®æ—é‚Šç·£ã€è‰å¸¶æˆ–ç”°å€è§’è½ç­‰ä¸æ˜“å—å¹²æ“¾è™•ã€‚<br><strong>ã€ææ–™ã€‘</strong>å°‡ä¿®å‰ªä¸‹ä¾†çš„æ¨¹æã€æ¯æœ¨ã€è½è‘‰ã€ç¨»è‰å †ç–Šå³å¯ï¼Œä¸éœ€éåº¦æ•´é½Šã€‚",sroiFarms:"æ¹§å¥é…ªæ¢¨è¾²å ´"},{id:"f13",name:"æ˜†èŸ²æ—…é¤¨",icon:"ğŸ¦‹",zone:"dz13",placed:!1,benefits:["farm_building"],reason:"ç‚ºç¨å±…èœ‚(å¦‚åˆ‡è‘‰èœ‚)ç­‰æˆç²‰æ˜†èŸ²ï¼Œä»¥åŠç“¢èŸ²ã€è‰è›‰ç­‰å¤©æ•µæ˜†èŸ²ï¼Œæä¾›ç¹æ®–èˆ‡éå†¬çš„ä½æ‰€ï¼Œæœ‰åŠ©æ–¼ä½œç‰©æˆç²‰èˆ‡ç”Ÿç‰©é˜²æ²»ã€‚",howto:"<strong>ã€ææ–™ã€‘</strong>ä½¿ç”¨æœ¨ç®±ã€ç«¹ç­’ã€é‘½å­”æœ¨å¡Šã€ç¨»è‰ã€æ¾æœç­‰å¤©ç„¶ææ–™å †ç–Šè€Œæˆã€‚<br><strong>ã€åœ°é»ã€‘</strong>è¨­ç½®åœ¨è‰å¸¶ã€æœåœ’æ—ï¼Œé›¢åœ°ç´„ 30-100 å…¬åˆ†ã€‚"},{id:"f14",name:"1959å‹•ä¿å°ˆç·š",icon:"ğŸ“",zone:"dz_dog",placed:!1,removes:["disturbance-dog","disturbance-roadkill"],reason:"é€šå ±æµæµªçŠ¬éš»èƒ½å¹«åŠ©ç›¸é—œå–®ä½é€²è¡Œé©ç•¶çš„å®‰ç½®ï¼Œæ¸›å°‘ç‰ å€‘å°é‡ç”Ÿå‹•ç‰©ï¼ˆå¦‚çŸ³è™ã€ç©¿å±±ç”²ï¼‰çš„è¿½é€èˆ‡æ”»æ“Šï¼Œä¿è­·æ·ºå±±ç”Ÿæ…‹ç³»çš„å®‰å…¨ã€‚è·¯æ®ºå°æ–¼ç”Ÿæ…‹äº¦æ˜¯å¹²æ“¾ï¼Œä¸è«–æ˜¯ç”Ÿç‰©æˆ–æ˜¯é§•é§›äººéƒ½å­˜åœ¨é¢¨éšªï¼Œè‹¥ç™¼ç¾æœ‰å‹•ç‰©è·¯æ®ºæƒ…æ³ï¼Œå¯ä»¥é€šå ±å‹•ä¿å°ˆç·šï¼Œç›¸é—œå–®ä½æœƒä¾å¯¦éš›æƒ…æ³ï¼Œè¨­ç«‹è­¦ç¤ºç‰Œæé†’ç”¨è·¯äººå°å¿ƒè¡Œé§›ï¼Œç¢ºä¿ç”Ÿç‰©åŠè‡ªèº«çš„å®‰å…¨ã€‚",howto:"æ’¥æ‰“1959å‹•ä¿å°ˆç·šï¼Œæ¸…æ¥šèªªæ˜æµæµªçŠ¬çš„ä½ç½®ã€æ•¸é‡ã€ç‰¹å¾µï¼Œè®“å°ˆæ¥­äººå“¡èƒ½æœ‰æ•ˆè™•ç†ã€‚"}
            ],
            dropZones:[{id:"dz1",position:{top:"71%",left:"5%",width:"28%",height:"4%"},cx:19,cy:73},{id:"dz3",position:{top:"32%",left:"72%",width:"5%",height:"6%"},cx:74.5,cy:35},{id:"dz5",position:{top:"70%",left:"2%",width:"3%",height:"25%"},cx:3.5,cy:82.5},{id:"dz6",position:{top:"85%",left:"25%",width:"22%",height:"10%"},cx:36,cy:90},{id:"dz8",position:{top:"40%",left:"68%",width:"8%",height:"38%"},cx:72,cy:59},{id:"dz9",position:{top:"50%",left:"93%",width:"5%",height:"30%"},cx:95.5,cy:65},{id:"dz10",position:{top:"82%",left:"78%",width:"15%",height:"10%"},cx:85.5,cy:87},{id:"dz11",position:{top:"38%",left:"30%",width:"22%",height:"8%"},cx:41,cy:42},{id:"dz12",position:{top:"45%",left:"0%",width:"10%",height:"10%"},cx:5,cy:50},{id:"dz13",position:{top:"68%",left:"42%",width:"10%",height:"10%"},cx:47,cy:73},{id:"dz_dog",position:{top:"31%",left:"90%",width:"8%",height:"6%"},cx:94,cy:34},],
            habitatAnchors:{forest:{cx:20,cy:30,name:"æ£®æ—"},water_edge:{cx:80,cy:50,name:"æ°´åŸŸé‚Šç·£"},wetland:{cx:88,cy:88,name:"æ¿•åœ°"},farm_building:{cx:60,cy:40,name:"è¨­æ–½å‘¨é‚Š"},farm_corridor:{cx:30,cy:65,name:"ç”°é–“å»Šé“"}}
        };
        
        const scene=document.getElementById("scene"),facilitiesList=document.getElementById("facilities-list"),feedbackModal=document.getElementById("feedback-modal"),modalTitle=document.getElementById("modal-title"),modalContent=document.getElementById("modal-content"),modalCloseBtn=document.getElementById("modal-close-btn"),sroiModal=document.getElementById("sroi-modal"),sroiModalCloseBtn=document.getElementById("sroi-modal-close-btn"),connectionCounterEl=document.getElementById("connection-counter"),canvas=document.getElementById("connection-canvas"),ctx=canvas?.getContext("2d"),animalPen=document.getElementById("animal-pen"),magicWandCursor=document.getElementById("magic-wand-cursor"); // Added safe navigation for getContext
        let sceneRect,selectedFacility=null,connectedHabitats=new Set,sroiModalShown=!1,placedFacilitiesCount=0, score=0, scoreDisplay; // Initialize score to 0
        
        function init(){
            scoreDisplay = document.getElementById("score-display");
            score = 0; // Ensure score is reset/initialized
            updateScoreDisplay();
            setTimeout(resizeCanvas, 0);
            window.addEventListener("resize", resizeCanvas);
            
            // Check if gameData.animals exists and is an array
            if (gameData && Array.isArray(gameData.animals)) {
                 const uniqueAnimals = [...new Map(gameData.animals.map(e => [e.name, e])).values()];
                 if (animalPen) { // Check if animalPen exists
                    animalPen.innerHTML = ''; // Clear previous animals if any
                    uniqueAnimals.forEach(e => {
                        if(e && e.name && e.icon) { // Add checks for animal data
                            const t = document.createElement("div");
                            t.id = `pen-${e.name}`;
                            t.className = "pen-animal";
                            t.textContent = e.icon;
                            animalPen.appendChild(t);
                        }
                    });
                 }
            }
            
            renderElements(gameData.animals, createAnimalElement);
            renderElements(gameData.disturbances, createDisturbanceElement);
            renderElements(gameData.facilities, createFacilityElement);
            renderElements(gameData.dropZones, createDropZoneElement);
            
            // Add null checks for modal buttons
            if (modalCloseBtn) modalCloseBtn.addEventListener("click", hideFeedbackModal);
            if (sroiModalCloseBtn) sroiModalCloseBtn.addEventListener("click", hideSroiModal);
            if (feedbackModal) {
                 feedbackModal.addEventListener("click", e => {
                    if (e.target === feedbackModal) hideFeedbackModal();
                 });
            }
             if (sroiModal) {
                sroiModal.addEventListener("click", e => {
                    if (e.target === sroiModal) hideSroiModal();
                });
             }
            document.addEventListener("mousemove", moveMagicWand);
            document.addEventListener("touchmove", moveMagicWand, { passive: false });
        }

        function resizeCanvas() {
            if (!scene || !canvas) return; // Add checks
            sceneRect = scene.getBoundingClientRect();
            canvas.width = sceneRect.width;
            canvas.height = sceneRect.height;
             if (!ctx) return; 
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            // Check if gameData exists and facilities is an array
            if (gameData && Array.isArray(gameData.facilities)) {
                gameData.facilities.forEach(e => {
                    if (e.placed) {
                        // Check dropZones exists and is an array
                        const t = Array.isArray(gameData.dropZones) ? gameData.dropZones.find(t => t.id === e.zone) : undefined;
                        // Check benefits exists and is an array
                        if (Array.isArray(e.benefits)) {
                            e.benefits.forEach(benefitKey => { // Use benefitKey
                                // Check habitatAnchors exists and has the key
                                const o = gameData.habitatAnchors && gameData.habitatAnchors[benefitKey];
                                if (t && o) drawConnectionLine(t, o);
                            });
                        }
                    }
                });
            }
        }

        function renderElements(dataArray, createElementFunc) { // Use descriptive names
             if (!dataArray || typeof dataArray[Symbol.iterator] !== 'function') {
                // console.error("Invalid data provided to renderElements:", dataArray); // Optional: Keep for debugging
                return; 
            }
            dataArray.forEach(item => { 
                const element = createElementFunc(item); // Use descriptive name
                if (element && element.classList.contains("facility")) {
                    if (facilitiesList) facilitiesList.appendChild(element);
                } else if (element) {
                   if (scene) scene.appendChild(element);
                }
            });
        }

        function createIconElement(itemData, isDisturbance = false) { // Use descriptive names
            const element = document.createElement("div"); // Use descriptive name
            if (!itemData || typeof itemData !== 'object' || !itemData.id || !itemData.name || !itemData.icon || !itemData.position) {
                // console.error("Invalid data for createIconElement:", itemData); // Optional: Keep for debugging
                return null; 
            }
            element.id = itemData.id;
            element.className = "game-icon";
            if (isDisturbance) {
                element.classList.add("disturbance-icon");
                element.innerHTML = `<div class="icon-symbol">â—ï¸</div><span>${itemData.name}</span>`;
            } else {
                element.classList.add("animal");
                 if (itemData.habitat) element.dataset.habitat = itemData.habitat; 
                element.innerHTML = `<div class="text-xl">${itemData.icon}</div><span>${itemData.name}</span>`;
            }
             // Add checks for position values
             if (itemData.position.top) element.style.top = itemData.position.top;
             if (itemData.position.left) element.style.left = itemData.position.left;
            return element;
        }
        
        function createAnimalElement(animalData) { // Use descriptive name
            const animalElement = createIconElement(animalData, false); // Use descriptive name
             if (!animalElement) return null; 
            animalElement.style.opacity = "0";
            animalElement.style.transform = "scale(0)";
            animalElement.style.top = "5%"; 
            animalElement.style.left = "95%";
            return animalElement;
        }

        function createDisturbanceElement(disturbanceData) { // Use descriptive name
            return createIconElement(disturbanceData, true);
        }

        function createFacilityElement(facilityData) { // Use descriptive name
            if (!facilityData || !facilityData.id || !facilityData.zone || !facilityData.icon || !facilityData.name) return null; 
            const facilityElement = document.createElement("div"); // Use descriptive name
            facilityElement.id = facilityData.id;
            facilityElement.dataset.zone = facilityData.zone;
            facilityElement.className = "facility bg-lime-100 p-2 rounded-lg border border-lime-300 flex items-center gap-2";
            facilityElement.addEventListener("click", handleFacilityClick);
            facilityElement.innerHTML = `<span class="text-lg">${facilityData.icon}</span><span class="text-xs">${facilityData.name}</span>`;
            return facilityElement;
        }

        function createDropZoneElement(dropZoneData) { // Use descriptive name
             if (!dropZoneData || !dropZoneData.id || !dropZoneData.position) return null; 
            const dropZoneElement = document.createElement("div"); // Use descriptive name
            dropZoneElement.id = dropZoneData.id;
            dropZoneElement.className = "drop-zone";
            if (dropZoneData.position.top) dropZoneElement.style.top = dropZoneData.position.top;
            if (dropZoneData.position.left) dropZoneElement.style.left = dropZoneData.position.left;
            if (dropZoneData.position.width) dropZoneElement.style.width = dropZoneData.position.width;
            if (dropZoneData.position.height) dropZoneElement.style.height = dropZoneData.position.height;
            
            dropZoneElement.addEventListener("click", handleDropZoneClick);
            dropZoneElement.addEventListener("dragover", (evt) => { 
                evt.preventDefault();
                dropZoneElement.classList.add("hovered");
            });
            dropZoneElement.addEventListener("dragleave", () => {
                dropZoneElement.classList.remove("hovered");
            });
            dropZoneElement.addEventListener("drop", (evt) => { 
                evt.preventDefault();
                dropZoneElement.classList.remove("hovered");
                if(selectedFacility) handleDropZoneClick({ currentTarget: dropZoneElement }); 
            });
            return dropZoneElement;
        }

        function moveMagicWand(e) {
            if (selectedFacility && magicWandCursor) { 
                const t = e.touches ? e.touches[0] : e;
                magicWandCursor.style.left = `${t.clientX}px`;
                magicWandCursor.style.top = `${t.clientY}px`;
            }
        }

        function handleFacilityClick(e) {
            const clickedElement = e.currentTarget; // Use descriptive name
            if (!clickedElement) return; 
            if (clickedElement.classList.contains("placed")) return;
            
            if (selectedFacility && selectedFacility.id === clickedElement.id) {
                clickedElement.classList.remove("selected");
                selectedFacility = null;
                 if (magicWandCursor) { 
                    magicWandCursor.style.opacity = "0";
                    setTimeout(() => magicWandCursor.style.display = "none", 200);
                 }
                return;
            }
            
            const currentlySelected = document.querySelector(".facility.selected"); // Use descriptive name
            if (currentlySelected) currentlySelected.classList.remove("selected");
            
            clickedElement.classList.add("selected");
            // Check facilities exists and is an array before find
            selectedFacility = Array.isArray(gameData?.facilities) ? gameData.facilities.find(fac => fac.id === clickedElement.id) : null; 
            
            if (magicWandCursor) { 
                 magicWandCursor.style.display = "block";
                 setTimeout(() => magicWandCursor.style.opacity = "1", 10);
            }
        }

        function updateScoreDisplay() {
            if (scoreDisplay) {
                 // Ensure score is a number before rounding
                scoreDisplay.textContent = `åˆ†æ•¸: ${typeof score === 'number' ? Math.round(score) : 'N/A'}`;
            }
        }

        function handleDropZoneClick(e) {
            if (!selectedFacility) return;
            const clickedDropZone = e.currentTarget; // Use descriptive name
            if (!clickedDropZone || clickedDropZone.classList.contains("occupied")) return; 
            
            const facilityData = selectedFacility; // Use descriptive name
             if (!facilityData) return; // Add check for facilityData
            const facilityElement = document.getElementById(facilityData.id); // Use descriptive name
            
            if (facilityData.zone === clickedDropZone.id) {
                 const facilitiesCount = Array.isArray(gameData?.facilities) ? gameData.facilities.length : 0; // Get count safely
                const pointsPerCorrect = facilitiesCount > 0 ? 100 / facilitiesCount : 0;
                score = (score || 0) + pointsPerCorrect; // Ensure score is a number
                placeFacility(facilityElement, clickedDropZone, facilityData);
            } else {
                 score = (score || 0) - 1; // Ensure score is a number
                showFeedbackModal(false);
            }
            updateScoreDisplay();
            
            if (facilityElement) facilityElement.classList.remove("selected");
            selectedFacility = null;
             if (magicWandCursor) { 
                 magicWandCursor.style.opacity = "0";
                 setTimeout(() => magicWandCursor.style.display = "none", 200);
             }
        }

        function releaseAnimals(habitats) { 
             if (!gameData.animals || !Array.isArray(habitats)) return; // Check arrays
            gameData.animals.forEach(animalData => { // Use descriptive name
                 // Add check for animalData
                if (animalData && habitats.includes(animalData.habitat) && !animalData.released) {
                    animalData.released = true;
                    const animalElement = document.getElementById(animalData.id); // Use descriptive name
                    const penElement = document.getElementById(`pen-${animalData.name}`); // Use descriptive name
                    if (animalElement) {
                        animalElement.style.top = animalData.position?.top || '0%'; 
                        animalElement.style.left = animalData.position?.left || '0%'; 
                        animalElement.style.opacity = "1";
                        animalElement.style.transform = "scale(1)";
                    }
                    if (penElement) {
                        penElement.style.opacity = "0.2"; 
                    }
                }
            });
            activateAnimals(habitats); 
        }

        function placeFacility(facilityElement, dropZoneElement, facilityData) { 
             if (!facilityData) return; 
            facilityData.placed = true;
            placedFacilitiesCount++;
            if (facilityElement) {
                facilityElement.classList.add("placed");
                facilityElement.removeEventListener("click", handleFacilityClick);
            }
             if (dropZoneElement) { 
                dropZoneElement.innerHTML = `<div class="w-full h-full flex items-center justify-center text-green-800 font-bold bg-green-200/80 p-1 text-xs text-center">${facilityData.name || ''}</div>`; 
                dropZoneElement.classList.add("occupied");
             }
            showFeedbackModal(true, facilityData);
            updateDisturbanceIcons();

            if (facilityData.removes) {
                const removals = Array.isArray(facilityData.removes) ? facilityData.removes : [facilityData.removes]; 
                removals.forEach(id => { 
                    const elementToRemove = document.getElementById(id); 
                    if (elementToRemove) {
                        elementToRemove.style.transition = "opacity 0.5s, transform 0.5s";
                        elementToRemove.style.opacity = "0";
                        elementToRemove.style.transform = "scale(0)";
                        setTimeout(() => elementToRemove.remove(), 500);
                    }
                });
            }

            if (facilityData.benefits) {
                releaseAnimals(facilityData.benefits);
                const dropZoneId = dropZoneElement?.id; // Get ID safely
                const dropZoneData = Array.isArray(gameData?.dropZones) ? gameData.dropZones.find(dz => dz.id === dropZoneId) : null; 
                
                if (Array.isArray(facilityData.benefits)) { // Check benefits is array
                    facilityData.benefits.forEach(benefitHabitat => { 
                        const anchorData = gameData.habitatAnchors?.[benefitHabitat]; 
                        if (dropZoneData && anchorData) {
                            drawConnectionLine(dropZoneData, anchorData);
                             if (anchorData.name) connectedHabitats.add(anchorData.name); 
                        }
                    });
                }
            }
             if (connectionCounterEl) updateConnectionCounter(); 
            checkCompletion();
        }

        function updateConnectionCounter() {
            if (!connectionCounterEl) return; 
            const count = connectedHabitats.size; 
            connectionCounterEl.textContent = `å·²é€£æ¥ ${count} å€‹ç”Ÿæ…‹æ£²åœ°ï¼š${[...connectedHabitats].join("ã€")}`;
            if (count > 0) {
                connectionCounterEl.classList.remove("bg-green-100", "text-green-700");
                connectionCounterEl.classList.add("bg-yellow-200", "text-yellow-800");
            } else { 
                 connectionCounterEl.classList.add("bg-green-100", "text-green-700");
                 connectionCounterEl.classList.remove("bg-yellow-200", "text-yellow-800");
            }
        }

        function updateDisturbanceIcons() {
            const disturbanceIcons = document.querySelectorAll(".disturbance-icon"); 
            const facilitiesCount = Array.isArray(gameData?.facilities) ? gameData.facilities.length : 0; // Get count safely
            const scaleFactor = facilitiesCount > 0 ? Math.max(0.1, 1 - (placedFacilitiesCount / facilitiesCount)) : 1; 
            disturbanceIcons.forEach(icon => {
                icon.style.transform = `scale(${scaleFactor})`;
            });
        }

        function checkCompletion() {
            if (Array.isArray(gameData?.facilities) && gameData.facilities.every(fac => fac.placed) && !sroiModalShown) {
                sroiModalShown = true;
                setTimeout(showSroiModal, 1200);
            }
        }

        function showFeedbackModal(isCorrect, facilityData) { 
            if (!feedbackModal) return; 
            const modalInnerDiv = feedbackModal.querySelector("div > div"); 
            if (modalInnerDiv) {
                if (isCorrect && facilityData) { 
                    if (modalTitle) modalTitle.textContent = `åšå¾—å¥½ï¼é€™æ˜¯ã€Œ${facilityData.name || ''}ã€`; 
                    let sroiHtml = ""; 
                    if (facilityData.sroiFarms) {
                        sroiHtml = `
                    <div class="mt-4 p-3 border-2 border-green-600 bg-green-50 rounded-lg">
                        <p class="font-bold text-green-800">â­ å·²å®Œæˆæœ¬é …è¨­æ–½ä¸¦è¨ˆç®—SROIä¹‹è¾²å ´ï¼š</p>
                        <p class="text-gray-700">${facilityData.sroiFarms}</p>
                    </div>
                    `;
                    }
                    if (modalContent) { 
                         modalContent.innerHTML = `
                        <div class="space-y-4">
                            <div>
                                <h4 class="text-lg font-semibold text-green-800 border-l-4 border-green-500 pl-2 mb-1">ğŸŒ¿ ç”Ÿæ…‹åŠŸèƒ½</h4>
                                <p class="text-gray-700 leading-relaxed">${facilityData.reason || ''}</p> 
                            </div>
                            <div>
                                <h4 class="text-lg font-semibold text-green-800 border-l-4 border-green-500 pl-2 mb-1">ğŸ› ï¸ å¦‚ä½•å»ºé€ </h4>
                                <div class="text-gray-700 leading-relaxed">${facilityData.howto || ''}</div>
                            </div>
                             <div class="mt-4 p-3 border-2 border-blue-400 bg-blue-50 rounded-lg">
                                <p class="text-blue-800">å› ç‚ºæ‚¨è¨­ç½®äº†ç”Ÿæ…‹ä¿è­·æªæ–½ï¼Œæ³¨æ„è¾²æ‘ç•«å¸ƒä¸­çš„é©šå˜†è™Ÿæœƒé€æ¼¸ç¸®å°ï¼›é€™äº›å¹²æ“¾ç”Ÿæ…‹çš„è¾²æ¥­ç”Ÿç”¢è¡Œç‚ºä¸¦ä¸æ˜¯æ¶ˆå¤±äº†ï¼Œè€Œæ˜¯å› ç‚ºå‹å–„ç”Ÿæ…‹ï¼Œè®“åŸæœ‰çš„å¹²æ“¾å°ç”Ÿæ…‹çš„å½±éŸ¿é™å¾—æ›´ä½äº†!é€™æ¨£è‰¯å–„çš„å¾ªç’°ä¸­ï¼Œè¾²å‹æ¼¸æ¼¸å—ç›Šæ–¼ç”Ÿæ…‹ï¼ŒåŒ–å­¸è³‡æçš„ä½¿ç”¨ä¹Ÿæœƒé€æ¼¸é™ä½!</p>
                            </div>
                            ${sroiHtml}
                        </div>
                        `;
                    }
                } else {
                     if (modalTitle) modalTitle.textContent = "å™¢å–”ï¼Œå†è©¦ä¸€æ¬¡ï¼";
                     if (modalContent) modalContent.innerHTML = "<p>é€™å€‹ä½ç½®å¥½åƒä¸å¤ªå°å–”ï¼Œæƒ³æƒ³çœ‹é€™å€‹è¨­æ–½æœ€èƒ½å¹«åŠ©åˆ°å“ªäº›ç”Ÿç‰©ï¼Œä»¥åŠå®ƒæ‡‰è©²æ”¾åœ¨å“ªè£¡æ‰èƒ½ç™¼æ®æœ€å¤§ä½œç”¨å‘¢ï¼Ÿ</p>";
                }
                feedbackModal.classList.remove("hidden");
                setTimeout(() => {
                    modalInnerDiv.classList.remove("scale-95", "opacity-0");
                }, 10);
            }
        }

        function hideFeedbackModal() {
             if (!feedbackModal) return; 
            const modalInnerDiv = feedbackModal.querySelector("div > div"); 
            if (modalInnerDiv) {
                modalInnerDiv.classList.add("scale-95", "opacity-0");
                setTimeout(() => {
                    feedbackModal.classList.add("hidden");
                }, 300);
            }
        }
        
        function showSroiModal() {
             if (!sroiModal) return; 
            const modalInnerDiv = sroiModal.querySelector("div > div"); 
            if (modalInnerDiv) {
                sroiModal.classList.remove("hidden");
                setTimeout(() => {
                    modalInnerDiv.classList.remove("scale-95", "opacity-0");
                }, 10);
            }
        }

        function hideSroiModal() {
             if (!sroiModal) return; 
            const modalInnerDiv = sroiModal.querySelector("div > div"); 
            if (modalInnerDiv) {
                modalInnerDiv.classList.add("scale-95", "opacity-0");
                setTimeout(() => {
                    sroiModal.classList.add("hidden");
                }, 300);
            }
        }

        function activateAnimals(habitats) { 
             if (!Array.isArray(habitats)) return; // Check habitats is array
            document.querySelectorAll(".animal").forEach(animalElement => { 
                if (animalElement.dataset?.habitat && habitats.includes(animalElement.dataset.habitat) && animalElement.style.opacity === "1") { 
                    animalElement.classList.add("active");
                    animalElement.style.setProperty("--x1", `${20 * (Math.random() - .5)}px`);
                    animalElement.style.setProperty("--y1", `${20 * (Math.random() - .5)}px`);
                    animalElement.style.setProperty("--x2", `${20 * (Math.random() - .5)}px`);
                    animalElement.style.setProperty("--y2", `${20 * (Math.random() - .5)}px`);
                    animalElement.style.setProperty("--x3", `${20 * (Math.random() - .5)}px`);
                    animalElement.style.setProperty("--y3", `${20 * (Math.random() - .5)}px`);
                }
            });
        }

        function drawConnectionLine(dropZoneData, anchorData) { 
            if (!canvas || !ctx || !dropZoneData || !anchorData) return; 
            const startX = ((dropZoneData.cx || 0) / 100) * canvas.width; 
            const startY = ((dropZoneData.cy || 0) / 100) * canvas.height;
            const endX = ((anchorData.cx || 0) / 100) * canvas.width;
            const endY = ((anchorData.cy || 0) / 100) * canvas.height;
            
            ctx.beginPath();
            ctx.moveTo(startX, startY);
            ctx.lineTo(endX, endY);
            ctx.strokeStyle = "rgba(255, 255, 0, 0.8)";
            ctx.lineWidth = 4;
            ctx.setLineDash([5, 5]);
            ctx.stroke();
            ctx.setLineDash([]); 
        }
        
        // --- Add checks for essential elements before calling init ---
        if (document.getElementById('scene') && 
            document.getElementById('facilities-list') &&
            document.getElementById('feedback-modal') &&
            document.getElementById('sroi-modal') &&
            document.getElementById('connection-counter') &&
            document.getElementById('connection-canvas') &&
            document.getElementById('animal-pen') &&
            document.getElementById('magic-wand-cursor') &&
            document.getElementById('score-display')) 
        {
             init(); // Call the main init function only if elements exist
        } else {
            console.error("One or more essential game elements are missing from the DOM.");
        }
        
    }); 
    </script>
</body>
</html>

